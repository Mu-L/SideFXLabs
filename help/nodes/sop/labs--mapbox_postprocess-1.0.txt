#type:     node
#context:  sop
#internal: labs::mapbox_postprocess::1.0
#icon:     SOP/labs::mapbox_postprocess::1.0
#since:    19.5

= Labs Mapbox Post-process =

"""Processes contiguous terrain tiles generated by _Labs Mapbox SOPs_."""

This node works on a contiguous group of terrain tiles generated by _Labs Mapbox SOPs_. It provides post-processing features decoupled from _Lab Mapbox SOP_, either because they are impossible to accomplish on individual terrain tiles, or because they offer more flexibility and better performance when moved to a separate node.

== Seamless Normals ==

For both heightfield tiling and mesh tiling, it is impossible to make normals seamless with _Labs Mapbox SOPs_ alone, because normals are inherently inconsistent between two sides of unfused borders. However, this node can make normals seamless because it can process all the tiles at once.

=== HeightField Tiles ===

Connect all heightfield tiles to a _Merge SOP_ and connect the _Merge SOP_ to this node's first input.

The seamless heightfield tiles generated by upstream _Labs Mapbox SOPs_ are indeed seamless in terms of the height values stored in the voxels. In other words, if you convert the heightfield tiles to mesh tiles, the mesh point positions will be seamless.

The heightfield tiles only appear to have seams in terms of shading. To completely remove any visible seams, turn on __HeightField Tiles__ > __Fuse HeightField Tiles__. This will fuse all the tiles into a single large heightfield.

NOTE:
    On jagged terrains, fusing the tiles occasionally introduces small shading differences compared to the original unfused tiles.

=== Mesh Tiles ===

Connect all mesh tiles to a _Merge SOP_ and connect the _Merge SOP_ to this node's second input.

The seamless mesh tiles generated by upstream __Labs Mapbox SOPs__ are seamless in terms of point positions, colors, and materials, but not in terms of point normals. To fix that, turn on __Mesh Tiles__ > __Make Border Normals Seamless__. This will make matched border points from adjacent tiles share a common normal value that is their average normal, thereby eliminating normal seams along the tile borders.

TIP:
    Unlike fusing heightfield tiles, there are no side effects to making border normals seamless on mesh tiles.


@parameters

    == HeightField Tiles ==

    Fuse HeightField Tiles:
        #id: fusehftiles
        Fuses all input heightfield tiles into a single large heightfield, removing any visible seams along the original tile borders.
        <p>If the heightfield output has no geometry when this is on, it is most likely because the input tiles do not all have the same resolution; please make sure that they do.</p>
        
    Keep Original Tiles:
        #id: keeporig
        Outputs the original unfused tiles, together with the single large tile.
        
    Resample Output Tiles:
        #id: resamplehf
        Resamples the output terrain tiles.
        
    === Resample ===

    Grid Samples:
        #id: gridsamples
        If __Fuse HeightField Tiles__ is on, this sets the resolution for the single large tile.
        <p>If any original tiles are present, they are also resampled to this resolution, meaning they will be denser than the single large tile.</p>
        
    Resample Filter:
        #id: filter
        The 2D filter to use to interpolate the resampled values. Different filters might give various blurring or sharpening effects in the output.
        
    Filter Scale:
        #id: filterscale  
        How much effect the filter will have on the output. High values can give more blurring, depending on the filter type.
        
    == Mesh Tiles ==

    === Input ===

    Border Point Group:
        #id: borderptgroup
        The name of the input point group that contains all the border points. By default, this group is created by upstream _Labs Mapbox SOPs_. This is used to speed up computation by limiting it to only border points.
        
    === Output ===

    Make Border Normals Seamless:
        #id: fixbordernorm
        Eliminates normal seams along the tile borders by making matched border points from adjacent tiles share a common normal value that is their average normal.
        
    Distance Tolerance:
        #id: seamdist
        A distance tolerance for matching border points from adjacent tiles. Higher values are more tolerant to tiny numerical errors.
        
@examples

    - [Example File|https://github.com/sideeffects/SideFXLabs/blob/Development/hip/examples/mapbox/mapbox.3.0.hip]